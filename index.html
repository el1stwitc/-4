<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resell Pro v10 Ultimate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-grad: linear-gradient(135deg, #da22ff 0%, #9733ee 100%);
            --bg-color: #f4f7f6;
            --danger: #ff4b5c;
            --success: #2ecc71;
            --warning: #f1c40f;
            --info: #3498db;
        }
        body { margin: 0; font-family: -apple-system, sans-serif; background-color: #222; height: 100vh; overflow: hidden; display: flex; justify-content: center; }
        #app-container { width: 100%; max-width: 414px; height: 100%; background: var(--bg-color); position: relative; display: flex; flex-direction: column; overflow: hidden; }
        header { background: var(--primary-grad); color: white; padding: 20px; text-align: center; font-weight: bold; }
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .form-group { background: white; padding: 12px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        label { display: block; font-size: 0.75rem; font-weight: bold; color: #777; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px; font-size: 0.9rem; outline: none; box-sizing: border-box; }
        
        /* –ö–∞—Ä—Ç–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤ */
        #damage-map { width: 150px; height: 260px; border: 2px solid #ddd; border-radius: 20px; margin: 10px auto; position: relative; background: #fff; background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px); background-size: 20px 20px; }
        .damage-point { position: absolute; width: 12px; height: 12px; background: var(--danger); border-radius: 50%; transform: translate(-50%, -50%); border: 2px solid white; }

        .card { background: white; padding: 12px; border-radius: 16px; margin-bottom: 10px; display: flex; gap: 12px; position: relative; border-left: 5px solid transparent; }
        .card.stock { border-left-color: var(--warning); }
        .card.reserve { border-left-color: var(--info); }
        .card.sold { border-left-color: var(--success); }
        .card.stale { border: 2px solid var(--danger); }
        
        .badge { position: absolute; right: 10px; top: 10px; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; color: white; }
        
        nav { position: absolute; bottom: 0; width: 100%; height: 80px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; padding-bottom: 10px; }
        nav button { background: none; border: none; color: #ccc; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; }
        nav button.active { color: #9733ee; }
        nav button i { font-size: 1.4rem; margin-bottom: 3px; }

        .btn-primary { width: 100%; padding: 15px; background: var(--primary-grad); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .checklist { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div id="datalist-container"></div>

<div id="app-container">
    <header>Resell Pro v10 Ultimate</header>
    <main>
        <div id="tab-add" class="tab-content active">
            <div class="form-group">
                <label>–û—Å–Ω–æ–≤–Ω–æ–µ</label>
                <select id="add-type" onchange="updateDatalists()">
                    <option value="phone">üì± –°–º–∞—Ä—Ç—Ñ–æ–Ω</option>
                    <option value="headphones">üéß –ù–∞—É—à–Ω–∏–∫–∏</option>
                    <option value="watch">‚åö –ß–∞—Å—ã</option>
                </select>
                <input id="b-brand" list="brands-dl" placeholder="–ë—Ä–µ–Ω–¥" style="margin-top:8px;">
                <input id="b-model" list="models-dl" placeholder="–ú–æ–¥–µ–ª—å" style="margin-top:8px;">
            </div>

            <div class="form-group">
                <label>–§–æ—Ç–æ (FYA89 Auto-Watermark)</label>
                <input type="file" multiple onchange="handlePhotos(this)">
                <div id="photo-preview-list" style="display:flex; gap:5px; margin-top:10px; overflow-x:auto;"></div>
            </div>

            <div class="form-group">
                <label>–ö–∞—Ä—Ç–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤ (—Ç–∞–ø–∞–π –ø–æ –∫–æ—Ä–ø—É—Å—É)</label>
                <div id="damage-map" onclick="addDamage(event)"></div>
                <center><small id="damage-count">–¢–æ—á–µ–∫: 0</small> | <button onclick="clearDamage()" style="font-size:0.6rem;">–°–±—Ä–æ—Å</button></center>
            </div>

            <div class="form-group">
                <label>–ö–æ–º–ø–ª–µ–∫—Ç –∏ –ü—Ä–æ–≤–µ—Ä–∫–∞</label>
                <div class="checklist">
                    <label><input type="checkbox" id="c-box"> –ö–æ—Ä–æ–±–∫–∞</label>
                    <label><input type="checkbox" id="c-check"> –ß–µ–∫/–î–æ–∫</label>
                    <label><input type="checkbox" id="ch-face"> FaceID/Touch</label>
                    <label><input type="checkbox" id="ch-truetone"> TrueTone</label>
                </div>
            </div>

            <div class="form-group" style="background:#fff9c4;">
                <label>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—ã–∫—É–ø–∞</label>
                <input type="number" id="calc-market" placeholder="–†—ã–Ω–æ–∫ ‚ÇΩ" oninput="runCalc()">
                <div id="calc-res" style="font-weight:bold; font-size:0.8rem; color:#f57f17; margin-top:5px;">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å: -</div>
            </div>

            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>–ó–∞–∫—É–ø</label><input type="number" id="inp-buy"></div>
                <div class="form-group" style="flex:1"><label>–†–µ–º–æ–Ω—Ç</label><input type="number" id="inp-repair" value="0"></div>
            </div>

            <button class="btn-primary" onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥</button>
        </div>

        <div id="tab-base" class="tab-content">
            <div id="base-list"></div>
        </div>

        <div id="tab-sell" class="tab-content">
            <div class="form-group"><label>–¢–æ–≤–∞—Ä</label><select id="sell-select"></select></div>
            <div class="form-group"><label>–°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏</label>
                <select id="sell-status">
                    <option value="sold">üí∞ –ü—Ä–æ–¥–∞–Ω–æ</option>
                    <option value="reserve">‚è≥ –í —Ä–µ–∑–µ—Ä–≤ (–î–µ–ø–æ–∑–∏—Ç)</option>
                </select>
            </div>
            <div class="form-group"><label>–¶–µ–Ω–∞ / –î–µ–ø–æ–∑–∏—Ç</label><input type="number" id="sell-price"></div>
            <div class="form-group"><label>–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä (–°–î–≠–ö/–ü–æ—á—Ç–∞)</label><input type="text" id="logistics-track"></div>
            <div class="form-group"><label>–ö–ª–∏–µ–Ω—Ç</label><input type="text" id="cust-info" placeholder="–ò–º—è / –ö–æ–Ω—Ç–∞–∫—Ç"></div>
            <button class="btn-primary" onclick="processTransaction()">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
        </div>

        <div id="tab-stats" class="tab-content">
            <div class="form-group" style="text-align:center;">
                <h3 id="stat-total-profit" style="margin:0; color:var(--success);">0 ‚ÇΩ</h3>
                <small>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</small>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><small>–í —Ç–æ–≤–∞—Ä–µ</small><div id="stat-in-stock">0</div></div>
                <div class="form-group"><small>–í —Ä–µ–∑–µ—Ä–≤–µ</small><div id="stat-in-reserve">0</div></div>
            </div>
            <button class="btn-primary" style="background:#555;" onclick="downloadBackup()">–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–π –±–∞–∑—ã</button>
        </div>
    </main>

    <nav>
        <button class="active" onclick="showTab('add', this)"><i class="fa-solid fa-plus-circle"></i>–í–≤–æ–¥</button>
        <button onclick="showTab('base', this)"><i class="fa-solid fa-boxes-stacked"></i>–°–∫–ª–∞–¥</button>
        <button onclick="showTab('sell', this)"><i class="fa-solid fa-cart-shopping"></i>–°–¥–µ–ª–∫–∞</button>
        <button onclick="showTab('stats', this)"><i class="fa-solid fa-vault"></i>–°–µ–π—Ñ</button>
    </nav>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('resell_v10')) || [];
    let tempPhotos = [];
    let damagePoints = [];

    const GLOBAL_DATABASE = {
        brands: ["Apple", "Samsung", "Xiaomi", "Google"],
        models: {
            phone: ["iPhone 16 Pro Max", "iPhone 15 Pro", "Galaxy S24 Ultra", "Pixel 9 Pro"],
            headphones: ["AirPods Pro 2", "Sony WH-1000XM5"],
            watch: ["Apple Watch Ultra 2", "Galaxy Watch 7"]
        }
    };

    function updateDatalists() {
        const type = document.getElementById('add-type').value;
        document.getElementById('datalist-container').innerHTML = `
            <datalist id="brands-dl">${GLOBAL_DATABASE.brands.map(b=>`<option value="${b}">`).join('')}</datalist>
            <datalist id="models-dl">${GLOBAL_DATABASE.models[type].map(m=>`<option value="${m}">`).join('')}</datalist>
        `;
    }

    function addDamage(e) {
        const rect = e.target.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        damagePoints.push({x, y});
        renderDamagePoints();
    }

    function renderDamagePoints() {
        const map = document.getElementById('damage-map');
        map.querySelectorAll('.damage-point').forEach(p => p.remove());
        damagePoints.forEach(p => {
            const div = document.createElement('div');
            div.className = 'damage-point';
            div.style.left = p.x + '%';
            div.style.top = p.y + '%';
            map.appendChild(div);
        });
        document.getElementById('damage-count').innerText = `–¢–æ—á–µ–∫: ${damagePoints.length}`;
    }

    function clearDamage() { damagePoints = []; renderDamagePoints(); }

    function runCalc() {
        const market = document.getElementById('calc-market').value;
        document.getElementById('calc-res').innerText = market ? `–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å: ${market - 5000} ‚ÇΩ` : "-";
    }

    async function handlePhotos(input) {
        tempPhotos = [];
        for (let f of input.files) {
            const data = await processImage(f);
            tempPhotos.push(data);
        }
        document.getElementById('photo-preview-list').innerHTML = tempPhotos.map(p => `<img src="${p}" style="width:50px; height:50px; object-fit:cover; border-radius:5px;">`).join('');
    }

    function processImage(file) {
        return new Promise(res => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 800; canvas.height = 800;
                    ctx.drawImage(img, 0, 0, 800, 800);
                    ctx.font = "bold 30px Arial";
                    ctx.fillStyle = "rgba(255,255,255,0.4)";
                    ctx.fillText("FYA89", 680, 770);
                    res(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
            reader.readAsDataURL(file);
        });
    }

    function addItem() {
        const item = {
            id: Date.now(),
            status: 'stock',
            dateIn: new Date().toISOString(),
            brand: document.getElementById('b-brand').value,
            model: document.getElementById('b-model').value,
            buy: parseFloat(document.getElementById('inp-buy').value || 0),
            rep: parseFloat(document.getElementById('inp-repair').value || 0),
            photos: tempPhotos,
            damages: [...damagePoints]
        };
        db.push(item); save(); location.reload();
    }

    function showTab(name, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + name).classList.add('active');
        btn.classList.add('active');
        if(name === 'base') renderBase();
        if(name === 'sell') {
            const active = db.filter(x => x.status !== 'sold');
            document.getElementById('sell-select').innerHTML = active.map(a => `<option value="${a.id}">${a.model} (${a.buy+a.rep}‚ÇΩ)</option>`).join('');
        }
        if(name === 'stats') updateStats();
    }

    function renderBase() {
        const list = document.getElementById('base-list');
        list.innerHTML = db.map(i => {
            const days = Math.floor((new Date() - new Date(i.dateIn))/86400000);
            return `
                <div class="card ${i.status} ${days > 30 ? 'stale' : ''}">
                    <img src="${i.photos[0] || ''}" style="width:50px; height:50px; object-fit:cover; border-radius:8px;">
                    <div>
                        <b>${i.model}</b><br><small>${days} –¥–Ω. –Ω–∞ —Å–∫–ª–∞–¥–µ</small>
                    </div>
                    <span class="badge" style="background:gray;">${i.status.toUpperCase()}</span>
                </div>
            `;
        }).join('');
    }

    function processTransaction() {
        const id = document.getElementById('sell-select').value;
        const idx = db.findIndex(x => x.id == id);
        db[idx].status = document.getElementById('sell-status').value;
        db[idx].sellPrice = parseFloat(document.getElementById('sell-price').value);
        db[idx].track = document.getElementById('logistics-track').value;
        db[idx].customer = document.getElementById('cust-info').value;
        save(); location.reload();
    }

    function updateStats() {
        const stockVal = db.filter(x => x.status === 'stock').reduce((a, b) => a + (b.buy+b.rep), 0);
        const reserveVal = db.filter(x => x.status === 'reserve').reduce((a, b) => a + b.sellPrice, 0);
        const profit = db.filter(x => x.status === 'sold').reduce((a, b) => a + (b.sellPrice - (b.buy+b.rep)), 0);
        
        document.getElementById('stat-in-stock').innerText = stockVal + " ‚ÇΩ";
        document.getElementById('stat-in-reserve').innerText = reserveVal + " ‚ÇΩ";
        document.getElementById('stat-total-profit').innerText = profit + " ‚ÇΩ";
    }

    function save() { localStorage.setItem('resell_v10', JSON.stringify(db)); }
    function downloadBackup() {
        const blob = new Blob([JSON.stringify(db)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='resell_v10.json'; a.click();
    }
    updateDatalists();
</script>
</body>
</html>
