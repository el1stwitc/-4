<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resell Pro Database Edition</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
 <style>
    :root {
        /* –ù–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç Aurora Borealis */
        --primary-grad: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        --bg-color: #000000; 
        --card-bg: #1c1c1e;  
        --danger: #ff453a;
        --success: #32d74b;
        --gold: #ffd60a;
        --text-main: #ffffff;
        --text-dim: #8e8e93;
    }

    /* –û–±–Ω–æ–≤–∏–º —Ç–∞–∫–∂–µ —Å–≤–µ—á–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–æ–¥ –Ω–æ–≤—ã–π —Ü–≤–µ—Ç */
    .btn-primary {
        width: 100%; padding: 18px; 
        background: var(--primary-grad);
        color: #000; /* –ù–∞ —ç—Ç–æ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–µ —á–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–µ—Ç—Å—è –ª—É—á—à–µ –∏ –¥–æ—Ä–æ–∂–µ */
        border: none; border-radius: 16px;
        font-size: 1rem; font-weight: 800; cursor: pointer;
        box-shadow: 0 8px 25px rgba(67, 233, 123, 0.3); /* –ó–µ–ª–µ–Ω–æ–≤–∞—Ç–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
        transition: transform 0.2s active;
    }

    /* –ò –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    nav button.active { color: #43e97b; }
    
    /* –¶–≤–µ—Ç –ø–æ–ª–æ—Å–∫–∏ —É –∫–∞—Ä—Ç–æ—á–µ–∫ "–í –Ω–∞–ª–∏—á–∏–∏" */
    .card.active::before { background: #43e97b; box-shadow: 2px 0 12px rgba(67, 233, 123, 0.5); }
</style>
</head>
<body>

<div id="datalist-container"></div>

<div id="details-modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div id="m-gallery" class="photo-gallery"></div>
        <h2 id="m-title" style="margin:0 0 15px 0; font-size:1.3rem;"></h2>
        <div id="m-details"></div>
        <button class="btn-primary" style="margin-top:15px;" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button id="btn-delete-item" style="width:100%; background:none; border:none; color:var(--danger); margin-top:15px; font-weight:bold;">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    </div>
</div>

<div id="app-container">
    <header id="header-title">–ù–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</header>

    <main>
        <div id="tab-add" class="tab-content active">
            <div class="form-group">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="add-type" onchange="updateDatalists(); renderAddForm();">
                    <option value="phone">üì± –°–º–∞—Ä—Ç—Ñ–æ–Ω</option>
                    <option value="headphones">üéß –ù–∞—É—à–Ω–∏–∫–∏</option>
                    <option value="watch">‚åö –ß–∞—Å—ã</option>
                </select>
            </div>

            <div class="form-group">
                <div class="photo-upload" onclick="document.getElementById('inp-photo').click()">
                    <i class="fa-solid fa-camera"></i>
                    <span>–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                </div>
                <input type="file" id="inp-photo" accept="image/*" multiple style="display:none" onchange="handlePhotos(this)">
                <div id="photo-preview-list" class="photo-preview-container"></div>
            </div>

            <div id="dynamic-form"></div>

            <div style="display:flex; gap:12px;">
                <div class="form-group" style="flex:1"><label>–ü–æ–∫—É–ø–∫–∞</label><input type="number" id="inp-buy" placeholder="0"></div>
                <div class="form-group" style="flex:1"><label>–†–µ–º–æ–Ω—Ç</label><input type="number" id="inp-repair" value="0"></div>
            </div>

            <div class="form-group">
                <label>–ó–∞–º–µ—Ç–∫–∏ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∫–æ–º–ø–ª–µ–∫—Ç)</label>
                <textarea id="inp-comment" rows="2"></textarea>
            </div>
            <button class="btn-primary" onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É</button>
        </div>

        <div id="tab-sell" class="tab-content">
            <div class="form-group"><label>–ü–æ–∏—Å–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ</label><input type="text" id="sell-search" placeholder="–ú–æ–¥–µ–ª—å –∏–ª–∏ IMEI..." oninput="renderSellList()"></div>
            <div class="form-group"><label>–¢–æ–≤–∞—Ä</label><select id="sell-select"></select></div>
            <div class="form-group"><label>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏</label><input type="number" id="sell-price" placeholder="‚ÇΩ"></div>
            <button class="btn-primary" onclick="completeSell()">–ü—Ä–æ–¥–∞–Ω–æ</button>
        </div>

        <div id="tab-base" class="tab-content">
            <div class="filter-row">
                <button class="filter-btn active" onclick="renderBase('phone', this)">–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã</button>
                <button class="filter-btn" onclick="renderBase('headphones', this)">–ù–∞—É—à–Ω–∏–∫–∏</button>
                <button class="filter-btn" onclick="renderBase('watch', this)">–ß–∞—Å—ã</button>
            </div>
            <div id="base-list"></div>
        </div>

        <div id="tab-stats" class="tab-content">
            <div style="background:white; border-radius:16px; padding:15px; height:180px; margin-bottom:15px;"><canvas id="statChart"></canvas></div>
            <div class="stat-card"><span>–ü—Ä–∏–±—ã–ª—å:</span><span id="stat-profit" class="stat-val">0 ‚ÇΩ</span></div>
            <div class="stat-card"><span>ROI:</span><span id="stat-roi" class="stat-val">0%</span></div>
            <div class="stat-card"><span>–°–¥–µ–ª–æ–∫:</span><span id="stat-count" class="stat-val">0</span></div>
            
            <div class="data-actions">
                <button class="btn-outline" onclick="downloadBackup()">
                    <i class="fa-solid fa-file-export"></i> –≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã (JSON)
                </button>
                <button class="btn-outline" onclick="document.getElementById('import-file').click()">
                    <i class="fa-solid fa-file-import"></i> –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                </button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="importBackup(this)">
            </div>
        </div>

        <div id="tab-history" class="tab-content"><div id="history-list"></div></div>
    </main>

    <nav>
        <button class="active" onclick="showTab('add', this)"><i class="fa-solid fa-plus-circle"></i>–í–≤–æ–¥</button>
        <button onclick="showTab('sell', this)"><i class="fa-solid fa-cash-register"></i>–ü—Ä–æ–¥–∞—Ç—å</button>
        <button onclick="showTab('base', this)"><i class="fa-solid fa-boxes-stacked"></i>–ë–∞–∑–∞</button>
        <button onclick="showTab('stats', this)"><i class="fa-solid fa-chart-line"></i>–°—Ç–∞—Ç.</button>
        <button onclick="showTab('history', this)"><i class="fa-solid fa-list-ul"></i>–õ–æ–≥</button>
    </nav>
</div>

<script>
    const GLOBAL_DATABASE = {
        brands: ["Apple", "Samsung", "Xiaomi", "Google", "Huawei", "Honor", "Sony", "Realme", "OnePlus", "Nothing"],
        models: {
            phone: [
                "iPhone 16 Pro Max", "iPhone 16 Pro", "iPhone 16 Plus", "iPhone 16",
                "iPhone 15 Pro Max", "iPhone 15 Pro", "iPhone 15 Plus", "iPhone 15",
                "iPhone 14 Pro Max", "iPhone 14 Pro", "iPhone 14", "iPhone 13 Pro Max", 
                "iPhone 13", "iPhone 13 mini", "iPhone 12 Pro", "iPhone 12", "iPhone 11",
                "Galaxy S24 Ultra", "Galaxy S24+", "Galaxy S24", "Galaxy S23 Ultra", "Galaxy S22 Ultra",
                "Redmi Note 13 Pro", "Poco F6 Pro", "Poco X6 Pro", "Xiaomi 14 Ultra"
            ],
            headphones: [
                "AirPods Pro 2", "AirPods 4 (ANC)", "AirPods 3", "AirPods Max", "Galaxy Buds 3 Pro", "Sony WH-1000XM5"
            ],
            watch: [
                "Apple Watch Ultra 2", "Apple Watch Series 10", "Apple Watch Series 9", "Galaxy Watch 7", "Huawei Watch GT 4"
            ]
        }
    };

    let db = JSON.parse(localStorage.getItem('resell_db_v8')) || [];
    let logs = JSON.parse(localStorage.getItem('resell_logs_v8')) || [];
    let tempPhotos = [];
    let chartObj = null;

    function updateDatalists() {
        const type = document.getElementById('add-type').value;
        let html = `<datalist id="brands-dl">${GLOBAL_DATABASE.brands.map(b => `<option value="${b}">`).join('')}</datalist>`;
        html += `<datalist id="models-dl">${GLOBAL_DATABASE.models[type].map(m => `<option value="${m}">`).join('')}</datalist>`;
        document.getElementById('datalist-container').innerHTML = html;
    }

    function renderAddForm() {
        const type = document.getElementById('add-type').value;
        const div = document.getElementById('dynamic-form');
        let h = `<div class="form-group"><label>–ë—Ä–µ–Ω–¥</label><input id="b-brand" list="brands-dl" placeholder="Apple"></div>
                 <div class="form-group"><label>–ú–æ–¥–µ–ª—å</label><input id="b-model" list="models-dl" placeholder="iPhone 15"></div>
                 <div class="form-group"><label>–¶–≤–µ—Ç</label><input id="b-color" placeholder="Space Black"></div>`;
        if(type === 'phone') h += `<div class="form-group"><label>–ü–∞–º—è—Ç—å (–ì–±)</label><input type="number" id="b-memory" placeholder="256"></div>`;
        h += `<div class="form-group"><label>IMEI / S/N</label><input id="b-imei" placeholder="–ù–æ–º–µ—Ä"></div>`;
        div.innerHTML = h;
    }

    updateDatalists();
    renderAddForm();

    async function handlePhotos(input) {
        tempPhotos = [];
        const files = Array.from(input.files);
        const preview = document.getElementById('photo-preview-list');
        preview.innerHTML = "";
        for (let file of files) {
            const data = await readFile(file);
            tempPhotos.push(data);
            preview.innerHTML += `<img src="${data}" class="mini-preview">`;
        }
    }

    function readFile(file) {
        return new Promise(res => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 600; canvas.height = 600;
                    ctx.drawImage(img, 0, 0, 600, 600);
                    res(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
            reader.readAsDataURL(file);
        });
    }

    function addItem() {
        const item = {
            id: Date.now(),
            type: document.getElementById('add-type').value,
            brand: document.getElementById('b-brand').value,
            model: document.getElementById('b-model').value,
            color: document.getElementById('b-color').value,
            imei: document.getElementById('b-imei').value,
            memory: document.getElementById('b-memory')?.value || '',
            buy: parseFloat(document.getElementById('inp-buy').value || 0),
            rep: parseFloat(document.getElementById('inp-repair').value || 0),
            comment: document.getElementById('inp-comment').value,
            photos: tempPhotos,
            status: 'stock',
            date: new Date().toISOString()
        };
        if(!item.brand || !item.buy) return alert("–ë—Ä–µ–Ω–¥ –∏ —Ü–µ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!");
        db.push(item);
        logs.unshift({t: `+ ${item.brand} ${item.model}`, d: new Date().toLocaleString(), type:'in'});
        save();
        location.reload();
    }

    function showTab(name, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + name).classList.add('active');
        btn.classList.add('active');
        if(name === 'sell') renderSellList();
        if(name === 'base') renderBase('phone', document.querySelectorAll('.filter-btn')[0]);
        if(name === 'stats') updateStats();
        if(name === 'history') renderHistory();
    }

    function renderBase(type, btn) {
        if(btn) {
            document.querySelectorAll('#tab-base .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        const filtered = db.filter(i => i.type === type);
        document.getElementById('base-list').innerHTML = filtered.length ? filtered.map(i => `
            <div class="card ${i.status === 'stock' ? 'active' : 'sold'}" onclick="openModal(${i.id})">
                <img src="${i.photos[0] || 'https://via.placeholder.com/70'}" class="card-img">
                <div class="card-info">
                    <h3 style="margin:0; font-size:1rem;">${i.brand} ${i.model}</h3>
                    <p style="margin:2px 0; font-size:0.8rem; color:#888;">${i.color} ${i.memory ? '| '+i.memory+'Gb' : ''}</p>
                    <p style="margin:0; font-weight:bold; color:${i.status === 'sold' ? 'var(--success)' : 'var(--gold)'}">
                        ${i.status === 'sold' ? (i.sellPrice-(i.buy+i.rep))+' ‚ÇΩ' : (i.buy+i.rep)+' ‚ÇΩ'}
                    </p>
                </div>
            </div>
        `).join('') : '<p style="text-align:center; color:#999; margin-top:50px;">–ü—É—Å—Ç–æ</p>';
    }

    function openModal(id) {
        const item = db.find(i => i.id == id);
        if(!item) return;
        const gallery = document.getElementById('m-gallery');
        gallery.innerHTML = item.photos.length ? item.photos.map(p => `<img src="${p}">`).join('') : '<img src="https://via.placeholder.com/300?text=–ë–µ–∑+—Ñ–æ—Ç–æ">';
        document.getElementById('m-title').innerText = `${item.brand} ${item.model}`;
        document.getElementById('m-details').innerHTML = `
            <div class="modal-row"><span class="modal-label">IMEI/SN</span><span class="modal-val">${item.imei || '-'}</span></div>
            <div class="modal-row"><span class="modal-label">–ó–∞—Ç—Ä–∞—Ç—ã</span><span class="modal-val">${item.buy + item.rep} ‚ÇΩ</span></div>
            ${item.status === 'sold' ? `<div class="modal-row"><span class="modal-label">–ü—Ä–æ–¥–∞–∂–∞</span><span class="modal-val" style="color:var(--success)">${item.sellPrice} ‚ÇΩ</span></div>` : ''}
            <div style="margin-top:10px;"><small style="color:#888">–ó–∞–º–µ—Ç–∫–∏:</small><p style="margin:4px 0; font-size:0.9rem;">${item.comment || '-'}</p></div>
        `;
        document.getElementById('btn-delete-item').onclick = () => deleteItem(item.id);
        document.getElementById('details-modal').style.display = 'flex';
    }

    function deleteItem(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            db = db.filter(i => i.id !== id);
            save(); closeModal(); location.reload();
        }
    }

    function closeModal() { document.getElementById('details-modal').style.display = 'none'; }

    function renderSellList() {
        const s = document.getElementById('sell-search').value.toLowerCase();
        const active = db.filter(i => i.status === 'stock' && (i.brand + i.model + i.imei).toLowerCase().includes(s));
        document.getElementById('sell-select').innerHTML = active.map(i => `<option value="${i.id}">${i.brand} ${i.model} (${i.buy+i.rep}‚ÇΩ)</option>`).join('');
    }

    function completeSell() {
        const id = document.getElementById('sell-select').value;
        const price = parseFloat(document.getElementById('sell-price').value);
        if(!id || !price) return alert("–î–∞–Ω–Ω—ã–µ!");
        const idx = db.findIndex(i => i.id == id);
        db[idx].status = 'sold';
        db[idx].sellPrice = price;
        db[idx].sellDate = new Date().toISOString();
        logs.unshift({t: `–ü—Ä–æ–¥–∞–Ω–æ: ${db[idx].model}`, d: new Date().toLocaleString(), type:'out'});
        save(); location.reload();
    }

    function updateStats() {
        const sold = db.filter(i => i.status === 'sold');
        let prof = 0, cost = 0;
        sold.forEach(i => { prof += (i.sellPrice - (i.buy+i.rep)); cost += (i.buy+i.rep); });
        document.getElementById('stat-profit').innerText = prof + " ‚ÇΩ";
        document.getElementById('stat-profit').style.color = prof >= 0 ? "var(--success)" : "var(--danger)";
        document.getElementById('stat-roi').innerText = cost > 0 ? ((prof/cost)*100).toFixed(1) + "%" : "0%";
        document.getElementById('stat-count').innerText = sold.length;
        renderChart(sold);
    }

    function renderChart(data) {
        const ctx = document.getElementById('statChart').getContext('2d');
        if(chartObj) chartObj.destroy();
        chartObj = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(i => new Date(i.sellDate).toLocaleDateString()),
                datasets: [{ label: 'Profit', data: data.map(i => i.sellPrice - (i.buy+i.rep)), borderColor: '#9733ee', tension: 0.4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function renderHistory() {
        document.getElementById('history-list').innerHTML = logs.map(l => `
            <div class="stat-card" style="border-left: 4px solid ${l.type==='in'?'#9733ee':'#2ecc71'}">
                <div style="font-size:0.85rem;"><b>${l.t}</b><br><small>${l.d}</small></div>
            </div>
        `).join('');
    }

    function save() {
        localStorage.setItem('resell_db_v8', JSON.stringify(db));
        localStorage.setItem('resell_logs_v8', JSON.stringify(logs));
    }

    function downloadBackup() {
        const blob = new Blob([JSON.stringify({db, logs})], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'resell_backup.json'; a.click();
    }

    function importBackup(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (data.db && data.logs) {
                    db = data.db; 
                    logs = data.logs; 
                    save(); 
                    alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!"); 
                    location.reload();
                } else {
                    alert("–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.");
                }
            } catch (err) {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞.");
            }
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>


